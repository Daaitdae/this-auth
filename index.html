<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë”¥ë‹¤ì´ë¸Œ ëª°ì… ë£¨í‹´</title>
<style>
body {
font-family: sans-serif;
padding: 2rem;
}
#authForm, #contentArea {
max-width: 500px;
margin: 0 auto;
}
input {
width: 100%;
margin-bottom: 0.3rem;
padding: 0.5rem;
font-size: 1rem;
}
.input-guide {
font-size: 0.8rem;
color: #666;
margin-bottom: 1rem;
}
button {
padding: 0.5rem 1rem;
font-size: 1rem;
}
#contentArea {
display: none;
}
#errorMessage {
color: red;
margin-top: 1rem;
font-size: 0.9rem;
display: none;
}
</style>
</head>
<body>
<h1>ë”¥ë‹¤ì´ë¸Œ ëª°ì… ë£¨í‹´</h1>

<div id="authForm">
<input type="text" id="userCodeInput" placeholder="ìœ ì € ì½”ë“œ ì…ë ¥" required />
<div class="input-guide">ğŸ”’ 4ì ì´ìƒ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</div>
<input type="text" id="subCode" placeholder="êµ¬ë… ì½”ë“œ ì…ë ¥ (ì„ íƒ)" />
<div class="input-guide">âœ¨ ì˜ˆ: X2AZ-8Q7P, Q8YJ-72GR ë“±</div>
<button id="submitBtn" disabled>ì‹œì‘í•˜ê¸°</button>
<div id="errorMessage"></div>
</div>

<div id="contentArea">
<iframe id="tallyForm" width="100%" height="700px" frameborder="0"></iframe>
</div>

<script>
function updateIframeBySubscription() {
const expireDate = localStorage.getItem("subExpire");
const nowDate = new Date();
const isSubscribed = expireDate && new Date(expireDate) > nowDate;
const userCode = localStorage.getItem("userCode");

const baseURL = isSubscribed
? "https://tally.so/r/with-question-form"
: "https://tally.so/r/goal-only-form";

const tallyURL = `${baseURL}?userCode=${encodeURIComponent(userCode)}`;
document.getElementById("tallyForm").src = tallyURL;
}

function validateInputs() {
const userCode = document.getElementById("userCodeInput").value.trim();
const isUserCodeValid = userCode.length >= 4;
document.getElementById("submitBtn").disabled = !isUserCodeValid;
}

function showError(message) {
const errorDiv = document.getElementById("errorMessage");
errorDiv.innerText = message;
errorDiv.style.display = "block";
}

window.addEventListener("DOMContentLoaded", function () {
const userCodeInput = document.getElementById("userCodeInput");
const subCodeInput = document.getElementById("subCode");
const submitBtn = document.getElementById("submitBtn");

const savedUserCode = localStorage.getItem("userCode");
if (savedUserCode) {
document.getElementById("authForm").style.display = "none";
document.getElementById("contentArea").style.display = "block";
updateIframeBySubscription();
}

userCodeInput.addEventListener("input", validateInputs);

submitBtn.addEventListener("click", function () {
const userCode = userCodeInput.value.trim();
const subCode = subCodeInput.value.trim().toUpperCase();
const postData = {
  userCode: userCode,
  subCode: subCode
};

fetch("https://script.google.com/macros/s/AKfycbwpjn2gwGEqfzy64GMs-VxQqOmLBIheTsnQIKPWxq0DCjwd32ol172GeYFdiBKotcVLmw/exec", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(postData)
})
.then(res => res.json())
.then(result => {
  console.log("âœ… ì„œë²„ ì‘ë‹µ:", result);

  if (result.status === "VALID" || result.status === "BASIC") {
    localStorage.setItem("userCode", userCode);

    if (result.status === "VALID" && result.expire) {
      localStorage.setItem("subExpire", result.expire);
    } else {
      localStorage.removeItem("subExpire");
    }

    document.getElementById("authForm").style.display = "none";
    document.getElementById("contentArea").style.display = "block";
    updateIframeBySubscription();
  } else if (result.status === "USED") {
    showError("âš ï¸ ì´ë¯¸ ì‚¬ìš©ëœ êµ¬ë… ì½”ë“œì…ë‹ˆë‹¤.");
  } else if (result.status === "INVALID") {
    showError("ğŸš« ìœ íš¨í•˜ì§€ ì•Šì€ êµ¬ë… ì½”ë“œì…ë‹ˆë‹¤.");
  } else {
    showError("âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
})
.catch(err => {
  console.error("âŒ ì„œë²„ ì˜¤ë¥˜:", err);
  alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
});
});
});
</script>
</body>
</html>
